# app.py
import streamlit as st
import pandas as pd
import os, re, tempfile, shutil
from pathlib import Path


FIELD_MAPPING = {
    "é€šè®¯åœ°å€": ("Address", "å­—ç¬¦å‹", 300, 0),
    "æ³•äººä»£è¡¨èº«ä»½è¯ä»¶ä»£ç ": ("InstReprIDCode", "å­—ç¬¦å‹", 40, 0),
    "æ³•äººä»£è¡¨è¯ä»¶ç±»å‹": ("InstReprIDType", "å­—ç¬¦å‹", 3, 0),
    "æ³•äººä»£è¡¨å§“å": ("InstReprName", "å­—ç¬¦å‹", 60, 0),
    "ç”³è¯·å•ç¼–å·": ("AppSheetSerialNo", "å­—ç¬¦å‹", 24, 0),
    "ä¸ªäººè¯ä»¶ç±»å‹åŠæœºæ„è¯ä»¶å‹": ("CertificateType", "å­—ç¬¦å‹", 3, 0),
    "æŠ•èµ„äººè¯ä»¶å·ç ": ("CertificateNo", "å­—ç¬¦å‹", 40, 0),
    "æŠ•èµ„äººæˆ·å": ("InvestorName", "å­—ç¬¦å‹", 200, 0),
    "äº¤æ˜“å‘ç”Ÿæ—¥æœŸ": ("TransactionDate", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 8, 0),
    "äº¤æ˜“å‘ç”Ÿæ—¶é—´": ("TransactionTime", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 6, 0),
    "ä¸ªäºº/æœºæ„æ ‡å¿—": ("IndividualOrInstitution", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 1, 0),
    "æŠ•èµ„äººé‚®æ”¿ç¼–ç ": ("PostCode", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 6, 0),
    "ç»åŠäººè¯ä»¶å·ç ": ("TransactorCertNo", "å­—ç¬¦å‹", 40, 0),
    "ç»åŠäººè¯ä»¶ç±»å‹": ("TransactorCertType", "å­—ç¬¦å‹", 3, 0),
    "ç»åŠäººå§“å": ("TransactorName", "å­—ç¬¦å‹", 60, 0),
    "æŠ•èµ„äººåŸºé‡‘äº¤æ˜“å¸å·": ("TransactionAccountID", "å­—ç¬¦å‹", 17, 0),
    "é”€å”®äººä»£ç ": ("DistributorCode", "å­—ç¬¦å‹", 9, 0),
    "ä¸šåŠ¡ä»£ç ": ("BusinessCode", "å­—ç¬¦å‹", 3, 0),
    "åŸºé‡‘ç®¡ç†äººåœ¨èµ„é‡‘æ¸…ç®—æœºæ„çš„äº¤æ”¶å¸å·": ("AcctNoOfFMInClearingAgency", "å­—ç¬¦å‹", 28, 0),
    "åŸºé‡‘ç®¡ç†äººåœ¨èµ„é‡‘æ¸…ç®—æœºæ„çš„äº¤æ”¶è´¦æˆ·å": ("AcctNameOfFMInClearingAgency", "å­—ç¬¦å‹", 60, 0),
    "åŸºé‡‘èµ„é‡‘æ¸…ç®—æœºæ„ä»£ç ": ("ClearingAgencyCode", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 9, 0),
    "æŠ•èµ„äººå‡ºç”Ÿæ—¥æœŸ": ("InvestorsBirthday", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 8, 0),
    "æŠ•èµ„äººåœ¨é”€å”®äººå¤„ç”¨äºäº¤æ˜“çš„èµ„é‡‘å¸å·": ("DepositAcct", "å­—ç¬¦å‹", 40, 0),
    "äº¤æ˜“æ‰€åœ¨åœ°åŒºç¼–å·": ("RegionCode", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 4, 0),
    "æŠ•èµ„äººå­¦å†": ("EducationLevel", "å­—ç¬¦å‹", 3, 0),
    "æŠ•èµ„äººE-MAILåœ°å€": ("EmailAddress", "å­—ç¬¦å‹", 40, 0),
    "æŠ•èµ„äººä¼ çœŸå·ç ": ("FaxNo", "å­—ç¬¦å‹", 40, 0),
    "æŠ•èµ„äººèŒä¸šä»£ç ": ("VocationCode", "å­—ç¬¦å‹", 5, 0),
    "æŠ•èµ„äººä½å€ç”µè¯": ("HomeTelNo", "å­—ç¬¦å‹", 40, 0),
    "æŠ•èµ„äººå¹´æ”¶å…¥": ("AnnualIncome", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 0),
    "æŠ•èµ„äººæ‰‹æœºå·ç ": ("MobileTelNo", "å­—ç¬¦å‹", 40, 0),
    "ç½‘ç‚¹å·ç ": ("BranchCode", "å­—ç¬¦å‹", 9, 0),
    "æŠ•èµ„äººå•ä½ç”µè¯å·ç ": ("OfficeTelNo", "å­—ç¬¦å‹", 40, 0),
    "æŠ•èµ„äººæˆ·åç®€ç§°": ("AccountAbbr", "å­—ç¬¦å‹", 20, 0),
    "å¯†å‡½ç¼–å·": ("ConfidentialDocumentCode", "å­—ç¬¦å‹", 8, 0),
    "æŠ•èµ„äººæ€§åˆ«": ("Sex", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 1, 0),
    "ä¸Šæµ·è¯åˆ¸å¸å·": ("SHSecuritiesAccountID", "å­—ç¬¦å‹", 10, 0),
    "æ·±åœ³è¯åˆ¸å¸å·": ("SZSecuritiesAccountID", "å­—ç¬¦å‹", 10, 0),
    "æŠ•èµ„äººåŸºé‡‘å¸å·": ("TAAccountID", "å­—ç¬¦å‹", 12, 0),
    "æŠ•èµ„äººç”µè¯å·ç ": ("TelNo", "å­—ç¬¦å‹", 40, 0),
    "ä½¿ç”¨çš„äº¤æ˜“æ‰‹æ®µ": ("TradingMethod", "å­—ç¬¦å‹", 8, 0),
    "æœªæˆå¹´äººæ ‡å¿—": ("MinorFlag", "å­—ç¬¦å‹", 1, 0),
    "å¯¹å¸å•å¯„é€é€‰æ‹©": ("DeliverType", "å­—ç¬¦å‹", 1, 0),
    "ç»åŠäººè¯†åˆ«æ–¹å¼": ("TransactorIDType", "å­—ç¬¦å‹", 1, 0),
    "åŸºé‡‘è´¦æˆ·å¡çš„å‡­è¯å·": ("AccountCardID", "å­—ç¬¦å‹", 8, 0),
    "å¤šæ¸ é“å¼€æˆ·æ ‡å¿—": ("MultiAcctFlag", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 1, 0),
    "å¯¹æ–¹é”€å”®äººå¤„æŠ•èµ„äººåŸºé‡‘äº¤æ˜“å¸å·": ("TargetTransactionAccountID", "å­—ç¬¦å‹", 17, 0),
    "æŠ•èµ„äººæ”¶æ¬¾é“¶è¡Œè´¦æˆ·æˆ·å": ("AcctNameOfInvestorInClearingAgency", "å­—ç¬¦å‹", 200, 0),
    "æŠ•èµ„äººæ”¶æ¬¾é“¶è¡Œè´¦æˆ·è´¦å·": ("AcctNoOfInvestorInClearingAgency", "å­—ç¬¦å‹", 40, 0),
    "æŠ•èµ„äººæ”¶æ¬¾é“¶è¡Œè´¦æˆ·å¼€æˆ·è¡Œ": ("ClearingAgency", "å­—ç¬¦å‹", 20, 0),
    "å¯¹å¸å•å¯„é€æ–¹å¼": ("DeliverWay", "å­—ç¬¦å‹", 8, 0),
    "æŠ•èµ„è€…å›½å®¶æˆ–åœ°åŒº": ("Nationality", "å­—ç¬¦å‹", 3, 0),
    "æ“ä½œï¼ˆæ¸…ç®—ï¼‰ç½‘ç‚¹ç¼–å·": ("NetNo", "å­—ç¬¦å‹", 9, 0),
    "ç»çºªäºº": ("Broker", "å­—ç¬¦å‹", 12, 0),
    "å·¥ä½œå•ä½åç§°": ("CorpName", "å­—ç¬¦å‹", 200, 0),
    "è¯ä»¶æœ‰æ•ˆæ—¥æœŸ": ("CertValidDate", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 8, 0),
    "æœºæ„ç»åŠäººèº«ä»½è¯ä»¶æœ‰æ•ˆæ—¥æœŸ": ("InstTranCertValidDate", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 8, 0),
    "æœºæ„æ³•äººèº«ä»½è¯ä»¶æœ‰æ•ˆæ—¥æœŸ": ("InstReprCertValidDate", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 8, 0),
    "å®¢æˆ·é£é™©ç­‰çº§": ("ClientRiskRate", "å­—ç¬¦å‹", 1, 0),
    "å©šå§»çŠ¶å†µ": ("MarriageStatus", "å­—ç¬¦å‹", 1, 0),
    "å®¶åº­äººå£æ•°": ("FamilyNum", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 2, 0),
    "å®¶åº­èµ„äº§": ("Penates", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "åª’ä½“åå¥½": ("MediaHobby", "å­—ç¬¦å‹", 1, 0),
    "æœºæ„ç±»å‹": ("InstitutionType", "å­—ç¬¦å‹", 3, 0),
    "æŠ•èµ„äººè‹±æ–‡å": ("EnglishFirstName", "å­—ç¬¦å‹", 20, 0),
    "æŠ•èµ„äººè‹±æ–‡å§“": ("EnglishFamliyName", "å­—ç¬¦å‹", 20, 0),
    "è¡Œä¸š": ("Vocation", "å­—ç¬¦å‹", 4, 0),
    "ä¼ä¸šæ€§è´¨": ("CorpoProperty", "å­—ç¬¦å‹", 2, 0),
    "å‘˜å·¥äººæ•°": ("StaffNum", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "å…´è¶£çˆ±å¥½ç±»å‹": ("Hobbytype", "å­—ç¬¦å‹", 2, 0),
    "çœ/ç›´è¾–å¸‚": ("Province", "å­—ç¬¦å‹", 6, 0),
    "å¸‚": ("City", "å­—ç¬¦å‹", 6, 0),
    "å¿/åŒº": ("County", "å­—ç¬¦å‹", 6, 0),
    "æ¨èäºº": ("CommendPerson", "å­—ç¬¦å‹", 40, 0),
    "æ¨èäººç±»å‹": ("CommendPersonType", "å­—ç¬¦å‹", 1, 0),
    "å—ç†æ–¹å¼": ("AcceptMethod", "å­—ç¬¦å‹", 1, 0),
    "å†»ç»“åŸå› ": ("FrozenCause", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 1, 0),
    "å†»ç»“æˆªæ­¢æ—¥æœŸ": ("FreezingDeadline", "æ•°å­—å­—ç¬¦å‹,é™äº0-9", 8, 0),
    "TAçš„åŸç¡®è®¤æµæ°´å·": ("OriginalSerialNo", "å­—ç¬¦å‹", 20, 0),
    "åŸç”³è¯·å•ç¼–å·": ("OriginalAppSheetNo", "å­—ç¬¦å‹", 24, 0),
    "æ‘˜è¦/è¯´æ˜": ("Specification", "å­—ç¬¦å‹", 60, 0),
    "æŠ•èµ„è€…äº§å“ä»£ç ": ("InvestorProCode", "å­—ç¬¦å‹", 30, 0),
    "è¾…åŠ©èº«ä»½è¯æ˜æ–‡ä»¶ç±»å‹": ("AuxCertType", "å­—ç¬¦å‹", 3, 0),
    "è¾…åŠ©èº«ä»½è¯æ˜æ–‡ä»¶å·ç ": ("AuxCertCode", "å­—ç¬¦å‹", 40, 0),
    "è¾…åŠ©èº«ä»½è¯æ˜æ–‡ä»¶æœ‰æ•ˆæ—¥æœŸ": ("AuxCertValidDate", "å­—ç¬¦å‹", 8, 0),
    "IPåœ°å€": ("IPAddress", "å­—ç¬¦å‹", 40, 0),
    "MACåœ°å€": ("MACAddress", "å­—ç¬¦å‹", 20, 0),
    "å›½é™…ç§»åŠ¨è®¾å¤‡è¯†åˆ«ç ": ("IMEI", "å­—ç¬¦å‹", 20, 0),
    "é€šç”¨å”¯ä¸€è¯†åˆ«ç ": ("UUID", "å­—ç¬¦å‹", 32, 0),
    "åŸºé‡‘ä»£ç ": ("FundCode", "å­—ç¬¦å‹", 6, 0),
    "å·¨é¢èµå›å¤„ç†æ ‡å¿—": ("LargeRedemptionFlag", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 1, 0),
    "ç”³è¯·åŸºé‡‘ä»½æ•°": ("ApplicationVol", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "ç”³è¯·é‡‘é¢": ("ApplicationAmount", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "é”€å”®ä½£é‡‘æŠ˜æ‰£ç‡": ("DiscountRateOfCommission", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 5, 4),
    "ç»“ç®—å¸ç§": ("CurrencyType", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 3, 0),
    "åŸç”³è´­æ—¥æœŸ": ("OriginalSubsDate", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "äº¤æ˜“ç”³è¯·æœ‰æ•ˆå¤©æ•°": ("ValidPeriod", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 2, 0),
    "é¢„çº¦èµå›å·¥ä½œæ—¥å¤©æ•°": ("DaysRedemptionInAdvance", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 5, 0),
    "é¢„çº¦èµå›æ—¥æœŸ": ("RedemptionDateInAdvance", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "å®šæœŸå®šé¢ç”³è´­æ—¥æœŸ": ("DateOfPeriodicSubs", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "TAç¡®è®¤äº¤æ˜“æµæ°´å·": ("TASerialNO", "å­—ç¬¦å‹", 20, 0),
    "å®šæœŸå®šé¢ç”³è´­æœŸé™": ("TermOfPeriodicSubs", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 5, 0),
    "æŒ‡å®šç”³è´­æ—¥æœŸ": ("FutureBuyDate", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "å¯¹æ–¹é”€å”®äººä»£ç ": ("TargetDistributorCode", "å­—ç¬¦å‹", 9, 0),
    "æ‰‹ç»­è´¹": ("Charge", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "å¯¹æ–¹ç½‘ç‚¹å·": ("TargetBranchCode", "å­—ç¬¦å‹", 9, 0),
    "å¯¹æ–¹æ‰€åœ¨åœ°åŒºç¼–å·": ("TargetRegionCode", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 4, 0),
    "çº¢åˆ©æ¯”ä¾‹": ("DividendRatio", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "è½¬æ¢æ—¶çš„ç›®æ ‡åŸºé‡‘ä»£ç ": ("CodeOfTargetFund", "å­—ç¬¦å‹", 6, 0),
    "äº¤æ˜“åç«¯æ”¶è´¹æ€»é¢": ("TotalBackendLoad", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "æ”¶è´¹ç±»åˆ«": ("ShareClass", "å­—ç¬¦å‹", 1, 0),
    "TAçš„åŸç¡®è®¤æ—¥æœŸ": ("OriginalCfmDate", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "æ˜ç»†æ ‡å¿—": ("DetailFlag", "å­—ç¬¦å‹", 1, 0),
    "åŸç”³è¯·æ—¥æœŸ": ("OriginalAppDate", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "é»˜è®¤åˆ†çº¢æ–¹å¼": ("DefDividendMethod", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 1, 0),
    "å®šæ—¶å®šé¢å“ç§ä»£ç ": ("VarietyCodeOfPeriodicSubs", "å­—ç¬¦å‹", 5, 0),
    "å®šæ—¶å®šé¢ç”³è´­åºå·": ("SerialNoOfPeriodicSubs", "å­—ç¬¦å‹", 5, 0),
    "å®šæœŸå®šé¢ç§ç±»": ("RationType", "å­—ç¬¦å‹", 1, 0),
    "å¯¹æ–¹åŸºé‡‘è´¦å·": ("TargetTAAccountID", "å­—ç¬¦å‹", 12, 0),
    "å¯¹æ–¹TAä»£ç ": ("TargetRegistrarCode", "å­—ç¬¦å‹", 18, 0),
    "TAå®¢æˆ·ç¼–å·": ("CustomerNo", "å­—ç¬¦å‹", 12, 0),
    "å¯¹æ–¹åŸºé‡‘ä»½é¢ç±»åˆ«": ("TargetShareType", "å­—ç¬¦å‹", 1, 0),
    "å®šæœŸå®šé¢åè®®å·": ("RationProtocolNo", "å­—ç¬¦å‹", 20, 0),
    "å®šæ—¶å®šé¢ç”³è´­èµ·å§‹æ—¥æœŸ": ("BeginDateOfPeriodicSubs", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "å®šæ—¶å®šé¢ç”³è´­ç»ˆæ­¢æ—¥æœŸ": ("EndDateOfPeriodicSubs", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "å®šæ—¶å®šé¢ç”³è´­æ¯æœˆå‘é€æ—¥": ("SendDayOfPeriodicSubs", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 2, 0),
    "ä¿ƒé”€æ´»åŠ¨ä»£ç ": ("SalesPromotion", "å­—ç¬¦å‹", 3, 0),
    "å¼ºåˆ¶èµå›ç±»å‹": ("ForceRedemptionType", "å­—ç¬¦å‹", 1, 0),
    "å¸¦èµ°æ”¶ç›Šæ ‡å¿—": ("TakeIncomeFlag", "å­—ç¬¦å‹", 1, 0),
    "å®šæŠ•ç›®çš„": ("PurposeOfPeSubs", "å­—ç¬¦å‹", 40, 0),
    "å®šæŠ•é¢‘ç‡": ("FrequencyOfPeSubs", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 5, 0),
    "å®šæŠ•å‘¨æœŸå•ä½": ("PeriodSubTimeUnit", "å­—ç¬¦å‹", 1, 0),
    "å®šæŠ•æœŸæ•°": ("BatchNumOfPeSubs", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "èµ„é‡‘æ–¹å¼": ("CapitalMode", "å­—ç¬¦å‹", 2, 0),
    "æ˜ç»†èµ„é‡‘æ–¹å¼": ("DetailCapticalMode", "å­—ç¬¦å‹", 2, 0),
    "è¡¥å·®è´¹æŠ˜æ‰£ç‡": ("BackenloadDiscount", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 5, 4),
    "ç»„åˆç¼–å·": ("CombineNum", "å­—ç¬¦å‹", 6, 0),
    "æŒ‡å®šè®¤è´­æ—¥æœŸ": ("FutureSubscribeDate", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 8, 0),
    "å·¨é¢è´­ä¹°å¤„ç†æ ‡å¿—": ("LargeBuyFlag", "æ•°å­—å­—ç¬¦å‹ï¼Œé™äº0â€”9", 1, 0),
    "æ”¶è´¹ç±»å‹": ("ChargeType", "å­—ç¬¦å‹", 1, 0),
    "æŒ‡å®šè´¹ç‡": ("SpecifyRateFee", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 9, 8),
    "æŒ‡å®šè´¹ç”¨": ("SpecifyFee", "æ•°å€¼å‹ï¼Œå…¶é•¿åº¦ä¸åŒ…å«å°æ•°ç‚¹ï¼Œå¯å‚ä¸æ•°å€¼è®¡ç®—", 16, 2),
    "è¿‡æˆ·åŸå› ": ("TransferReason", "å­—ç¬¦å‹", 3, 0),
}


def format_field(value, field_type, field_length, decimal_places=0):
    if pd.isna(value) or not str(value).strip():
        return " " * field_length
    if "æ•°å€¼å‹" in field_type or "æ•°å­—å­—ç¬¦å‹" in field_type:
        try:
            cleaned = re.sub(r"[^\d.]", "", str(value))
            num = float(cleaned)
            formatted = f"{num:.{decimal_places}f}".replace(".", "")
            return formatted.zfill(field_length)
        except:
            return " " * field_length
    return str(value).ljust(field_length)[:field_length]

def excel_to_txt(data_file):
    """è¿”å›ç”Ÿæˆçš„ txt æ–‡ä»¶è·¯å¾„"""
    # è§£ææ–‡ä»¶å
    base_name = Path(data_file).stem
    parts = base_name.split('_')
    if len(parts) != 5 or parts[0] != 'OFD':
        raise ValueError("æ–‡ä»¶åæ ¼å¼å¿…é¡»æ˜¯ï¼šOFD_åˆ›å»ºäºº_æ¥æ”¶äºº_æ—¥æœŸ_ç±»å‹.xlsx")
    creator, receiver, date, file_type = parts[1], parts[2], parts[3], parts[4]

    # è¯» Excel
    df = pd.read_excel(data_file, dtype=str, keep_default_na=False).fillna("")

    # ç”Ÿæˆä¸´æ—¶è¾“å‡ºæ–‡ä»¶
    output_file = Path(tempfile.gettempdir()) / f"{base_name}.TXT"
    with open(output_file, 'w', encoding='gb18030', newline='\r\n') as f:
        f.write(f"OFDCFDAT\n22\n{creator}\n{receiver}\n{date}\n00000000\n{file_type}\n\n\n")
        f.write(f"{len(df.columns):08d}\n")
        for col in df.columns:
            f.write(f"{FIELD_MAPPING[col][0]}\n")
        f.write(f"{len(df):016d}\n")
        for _, row in df.iterrows():
            record = []
            for col in df.columns:
                _, field_type, length, decimal = FIELD_MAPPING[col]
                record.append(format_field(row[col], field_type, length, decimal))
            f.write("".join(record) + "\n")
        f.write("OFDCFEND")
    return output_file
# ========================================

# Streamlit é¡µé¢
st.set_page_config(page_title="OFD è½¬æ¢å·¥å…·", layout="centered")
st.title("ğŸ“ OFD Excel â†’ TXT è½¬æ¢å™¨")
st.markdown("ä¸Šä¼ ç¬¦åˆå‘½åè§„åˆ™çš„ Excelï¼Œä¸€é”®ç”Ÿæˆ TXT å¹¶ä¸‹è½½ã€‚")

uploaded = st.file_uploader("é€‰æ‹© Excel æ–‡ä»¶", type=["xlsx"])
if uploaded:
    if st.button("ğŸ”§ å¼€å§‹è½¬æ¢"):
        try:
            with st.spinner("æ­£åœ¨è½¬æ¢..."):
                # ä¿å­˜ä¸Šä¼ æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
                temp_excel = Path(tempfile.gettempdir()) / uploaded.name
                with open(temp_excel, "wb") as f:
                    f.write(uploaded.getbuffer())

                # è°ƒç”¨è½¬æ¢å‡½æ•°
                txt_path = excel_to_txt(temp_excel)

            st.success("âœ… è½¬æ¢å®Œæˆï¼")
            with open(txt_path, "rb") as f:
                st.download_button(
                    label="â¬‡ï¸ ä¸‹è½½ TXT",
                    data=f,
                    file_name=txt_path.name,
                    mime="text/plain"
                )

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            os.remove(temp_excel)
            os.remove(txt_path)

        except Exception as e:
            st.error(f"è½¬æ¢å¤±è´¥ï¼š{e}")